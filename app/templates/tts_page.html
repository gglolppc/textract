{% extends "base.html" %}
{% block title %}Text to Speech ‚Äî textract.me{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto mt-10 border rounded-2xl shadow-sm bg-white p-6">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

    <!-- LEFT TEXT AREA -->
    <div class="md:col-span-2 flex flex-col">
      <div class="flex items-center justify-between mb-2">
        <label class="text-sm font-medium">Enter your text</label>
        <span id="charCount" class="text-sm text-gray-500" data-max="2000">0 / 2000</span>
      </div>

      <textarea id="ttsText"
                class="w-full h-80 border rounded-xl p-4 focus:ring-2 focus:ring-purple-500 resize-none"
                placeholder="Type something to convert to speech..."></textarea>
    </div>

    <!-- RIGHT CONTROL PANEL -->
    <div class="flex flex-col justify-start items-stretch bg-gray-50 border rounded-xl shadow-inner p-6">
      <div class="w-full space-y-4">

        <!-- Voice row -->
        <div class="flex items-center justify-between">
          <label class="text-sm font-medium">Voice:</label>
          <select id="voiceSelect"
                  class="border rounded-lg px-3 py-1 focus:ring-2 focus:ring-purple-500 ml-3 flex-1">
            {% for v in voices %}
              <option value="{{v}}">{{v}}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Duration row -->
        <div class="flex items-center justify-between">
          <label class="text-sm font-medium">Will take about:</label>
          <div id="durationDisplay"
               class="rounded-lg px-4 py-1 text-gray-700 font-semibold ml-3 flex-1 text-right">
            0:00
          </div> minutes.
        </div>

        <!-- Generate button -->
        <button id="generateBtn"
                class="w-full bg-gradient-to-r from-purple-600 to-indigo-700 hover:from-purple-700 hover:to-indigo-800 text-white font-semibold py-3 rounded-lg shadow transition">
          üéß Generate
        </button>
      </div>
    </div>
  </div>

  <!-- RESULT BLOCK -->
  <div class="mt-8 border-t pt-6 text-center">
    <h3 class="text-lg font-semibold mb-3 text-gray-800">Result</h3>
    <div id="statusText" class="text-sm text-gray-500 mb-4"></div>
    <audio id="audioPlayer" controls class="w-full hidden"></audio>
  </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="fixed top-1/3 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center space-y-3"></div>
{% endblock %}

{% block extra_scripts %}
<script>
const textarea = document.getElementById("ttsText");
const generateBtn = document.getElementById("generateBtn");
const player = document.getElementById("audioPlayer");
const voiceSelect = document.getElementById("voiceSelect");
const durationDisplay = document.getElementById("durationDisplay");
const charCount = document.getElementById("charCount");
const toastContainer = document.getElementById("toastContainer");
const statusText = document.getElementById("statusText");
const maxChars = parseInt(charCount.dataset.max, 10) || 2000;

// --- Toast helper ---
function showToast(message, type = "error") {
  const colors = {
    error: "bg-red-600",
    success: "bg-green-600",
    info: "bg-blue-600"
  };
  const toast = document.createElement("div");
  toast.className = `
    ${colors[type] || colors.error}
    text-white px-6 py-3 rounded-xl shadow-lg font-medium text-center
    transition-all duration-500 opacity-0 transform translate-y-[-10px]
  `;
  toast.innerText = message;
  toastContainer.appendChild(toast);
  requestAnimationFrame(() => {
    toast.classList.remove("opacity-0", "translate-y-[-10px]");
    toast.classList.add("opacity-100", "translate-y-0");
  });
  setTimeout(() => {
    toast.classList.remove("opacity-100", "translate-y-0");
    toast.classList.add("opacity-0", "translate-y-[-10px]");
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}

// --- Live duration + char counter ---
textarea.addEventListener("input", () => {
  const text = textarea.value;
  const length = text.length;
  charCount.innerText = `${length} / ${maxChars}`;
  charCount.classList.toggle("text-red-600", length > maxChars);
  charCount.classList.toggle("text-gray-500", length <= maxChars);

  const trimmed = text.trim();
  if (!trimmed) {
    durationDisplay.innerText = "0:00";
    return;
  }
  const words = trimmed.split(/\s+/).length;
  const seconds = Math.round((words / 150) * 60);
  const min = Math.floor(seconds / 60);
  const sec = seconds % 60;
  durationDisplay.innerText = `${min}:${sec.toString().padStart(2, "0")}`;
});

// --- Polling Celery task ---
async function pollStatus(taskId) {
  try {
    const res = await fetch(`/text-to-speech/status/${taskId}`);
    const data = await res.json();

    if (data.status === "done") {
      player.src = data.audio_url;
      player.classList.remove("hidden");
      player.load();
      statusText.innerText = "‚úÖ Audio ready!";
      showToast("Audio generated successfully!", "success");
    } else if (data.status === "error") {
      statusText.innerText = "‚ùå Generation failed.";
      showToast(data.message || "Generation failed.", "error");
    } else {
      statusText.innerText = `‚è≥ ${data.status}...`;
      setTimeout(() => pollStatus(taskId), 3000);
    }
  } catch (err) {
    statusText.innerText = "‚ö†Ô∏è Connection error";
    console.error(err);
    setTimeout(() => pollStatus(taskId), 5000);
  }
}

// --- Generate TTS ---
generateBtn.addEventListener("click", async () => {
  const text = textarea.value.trim();
  if (!text) return showToast("Please enter text first.", "info");
  if (text.length > maxChars) return showToast("Text too long. Please stay under limit.", "error");

  generateBtn.disabled = true;
  generateBtn.innerText = "Queuing...";
  player.classList.add("hidden");
  statusText.innerText = "";

  try {
    const res = await fetch("/text-to-speech", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text, voice: voiceSelect.value })
    });

    const data = await res.json();
    if (data.error) {
      showToast(data.error, "error");
      return;
    }

    showToast("Task queued. Please wait...", "info");
    statusText.innerText = "‚è≥ Task queued...";
    pollStatus(data.task_id);
  } catch (err) {
    showToast("‚ö†Ô∏è Error: " + err.message, "error");
  } finally {
    generateBtn.disabled = false;
    generateBtn.innerText = "üéß Generate";
  }
});
</script>
{% endblock %}
