{% extends "base.html" %}
{% block title %}My History ‚Äî {{ user.email }}{% endblock %}
{% block description %}View and download your OCR and TTS results{% endblock %}

{% block content %}
<div class="bg-gray-50 rounded-2xl shadow-lg p-6 space-y-10">

  <!-- Navigation Tabs -->
  <div class="flex justify-center gap-8 mb-8 border-b border-gray-200">
    <a href="/account/"
       class="pb-2 text-sm font-medium {{ 'border-b-2 border-purple-600 text-purple-600' if request.url.path == '/account/' else 'text-gray-500 hover:text-gray-700' }}">
       üìã Details
    </a>
    <a href="/account/history"
       class="pb-2 text-sm font-medium {{ 'border-b-2 border-purple-600 text-purple-600' if request.url.path == '/account/history' else 'text-gray-500 hover:text-gray-700' }}">
       ‚è± History
    </a>
  </div>


  <!-- üìù OCR TABLE -->
  <div>
    <h2 class="text-2xl font-semibold mb-3 text-indigo-600 flex items-center gap-2">
      üìù <span>OCR Requests</span>
    </h2>
    <div class="overflow-x-auto rounded-lg border bg-white shadow-sm">
      <table class="min-w-full table-fixed text-sm text-gray-700 text-center border-separate border-spacing-y-1">
        <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
          <tr>
            <th class="px-4 py-2 w-1/3 text-center">Date</th>
            <th class="px-4 py-2 w-1/3 text-center">Result</th>
            <th class="px-4 py-2 w-1/3 text-center">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for log in ocr_logs %}
          <tr class="hover:bg-gray-50 transition">
            <td class="px-4 py-2">{{ log.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
            <td class="px-4 py-2 text-center">
              {% if not log.pdf_link %}
                <button
                  class="w-32 flex items-center justify-center gap-1 text-purple-600 hover:underline transition
                         mx-auto appearance-none border-none bg-transparent p-0"
                  onclick="generatePdf({{ log.id }}, this)">
                  ‚ú® Generate PDF
                </button>
              {% else %}
                <a href="/static/{{ log.pdf_link }}"
                   class="w-32 flex items-center justify-center gap-1 text-purple-600 hover:underline mx-auto"
                   download>
                   üìÑ Download PDF
                </a>
              {% endif %}
            </td>
            <td class="px-4 py-2">
              {% if log.status == 'success' %}
                <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-md text-xs font-medium">Success</span>
              {% elif log.status == 'fail' %}
                <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-md text-xs font-medium">Failed</span>
              {% else %}
                <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-md text-xs font-medium">{{ log.status|capitalize }}</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="3" class="px-4 py-3 text-center text-gray-400 italic">No OCR requests yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- üéôÔ∏è TTS TABLE -->
  <div>
    <h2 class="text-2xl font-semibold mb-3 text-purple-600 flex items-center gap-2">
      üéôÔ∏è <span>TTS Requests</span>
    </h2>
    <div class="overflow-x-auto rounded-lg border bg-white shadow-sm">
      <table class="min-w-full table-fixed text-sm text-gray-700 text-center border-separate border-spacing-y-1">
        <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
          <tr>
            <th class="px-4 py-2 w-1/3 text-center">Date</th>
            <th class="px-4 py-2 w-1/3 text-center">Result</th>
            <th class="px-4 py-2 w-1/3 text-center">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for log in tts_logs %}
          <tr class="hover:bg-gray-50 transition">
            <td class="px-4 py-2">{{ log.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
            <td class="px-4 py-2 text-center">
              {% if log.audio_link %}
                <a href="/text-to-speech/download/{{ log.audio_link }}"
                   class="w-32 flex items-center justify-center gap-1 text-purple-600 hover:underline mx-auto"
                   download>
                   üéß Download
                </a>
              {% else %}
                <span class="italic text-gray-400">‚Äî</span>
              {% endif %}
            </td>
            <td class="px-4 py-2">
              {% if log.status == 'success' %}
                <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-md text-xs font-medium">Success</span>
              {% elif log.status == 'fail' %}
                <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-md text-xs font-medium">Failed</span>
              {% else %}
                <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-md text-xs font-medium">{{ log.status|capitalize }}</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="3" class="px-4 py-3 text-center text-gray-400 italic">No TTS history yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- JS: PDF Generation -->
<script>
async function generatePdf(logId, btn) {
  btn.disabled = true;
  btn.innerText = "‚è≥ Generating...";
  btn.classList.add("text-gray-400");

  try {
    const res = await fetch(`/account/history/generate-pdf/${logId}`, { method: "POST" });
    const data = await res.json();

    if (data.status === "ok" || data.status === "exists") {
      btn.outerHTML = `
        <a href="${data.pdf_url}"
           class="w-32 flex items-center justify-center gap-1 text-purple-600 hover:underline mx-auto"
                   download>
           üìÑ Download PDF
        </a>`;
    } else {
      btn.innerText = "Error";
      btn.classList.add("text-red-500");
    }
  } catch {
    btn.innerText = "Error";
    btn.classList.add("text-red-500");
  }
}
</script>
{% endblock %}
